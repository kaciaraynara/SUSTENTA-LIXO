<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Gestor - Sustenta CE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Importa√ß√µes do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARI√ÅVEIS DE AMBIENTE DO CANVAS ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // Gemini API Key provided by environment

        let db, auth;
        let currentUserId = null;
        let dbInitialized = false;
        let currentFilter = 'Todos';

        // Elementos da UI
        const loginScreen = document.getElementById('screen-login');
        const mainContent = document.getElementById('main-content');
        const relatosListEl = document.getElementById('relatos-list-web');
        const filterButtons = {
            'Todos': document.getElementById('filter-todos'),
            'Pendente': document.getElementById('filter-pendente'),
            'Em Andamento': document.getElementById('filter-andamento'),
            'Concluido': document.getElementById('filter-concluido')
        };

        // --- FUN√á√ÉO GEMINI AI PARA AN√ÅLISE ---
        window.analyzeImpact = async (desc, btnId) => {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const prompt = `Aja como um analista de saneamento urbano. Analise o seguinte relato de lixo: "${desc}". Classifique o impacto ambiental (Baixo, M√©dio, Alto) e d√™ uma recomenda√ß√£o de prioridade para a equipe de coleta. Responda curto: "Impacto: [N√≠vel] | Prioridade: [Recomenda√ß√£o]".`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error('Falha na API Gemini');
                const data = await response.json();
                const analysis = data.candidates[0].content.parts[0].text;

                alert(`üìä An√°lise de IA:\n\n${analysis}`);

            } catch (error) {
                console.error("Erro IA:", error);
                alert("Erro ao analisar impacto.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };
        // --- FIM FUN√á√ÉO GEMINI AI ---

        // Inicializa√ß√£o do Firebase
        async function initializeFirebase() {
            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');
                    console.log("Firebase Inicializado (Web).");
                    await setupAuthListener();
                } else {
                    console.error("Configura√ß√£o do Firebase n√£o encontrada (Web). Usando dados mockados.");
                    loadMockData();
                }
            } catch (error) {
                console.error("Erro ao inicializar o Firebase (Web):", error);
                showToast("Erro de Conex√£o. Usando dados mockados.", true);
                loadMockData();
            }
        }

        // Configura√ß√£o do Listener de Autentica√ß√£o
        async function setupAuthListener() {
            if (!auth) return;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    dbInitialized = true;
                    loginScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    loadRelatos(); // Chama o load ap√≥s a autentica√ß√£o
                } else {
                    currentUserId = null;
                    dbInitialized = false;
                    signIn();
                }
            });
        }

        // Fun√ß√£o de Login
        async function signIn() {
            if (!auth) return;
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    showToast("Token de autentica√ß√£o n√£o encontrado.", true);
                }
            } catch (error) {
                console.error("Erro no login com Token (Web):", error);
                showToast("Erro de autentica√ß√£o.", true);
            }
        }
        
        // Fun√ß√£o de Logout
        window.logOut = async function() {
            if (!auth) return;
            try {
                await signOut(auth);
                currentUserId = null;
                dbInitialized = false;
                mainContent.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            } catch (error) {
                console.error("Erro ao deslogar (Web):", error);
            }
        }

        // Carregar Relatos do Firestore
        function loadRelatos() {
            // FIX: Garante que o UID est√° presente antes de tentar qualquer consulta
            if (!dbInitialized || !currentUserId) {
                 console.warn("Aguardando autentica√ß√£o para carregar relatos.");
                 return;
            }
            
            const relatosCollection = collection(db, "artifacts", appId, "public", "data", "relatos");
            const q = query(relatosCollection); 

            onSnapshot(q, (snapshot) => {
                relatosListEl.innerHTML = ''; 
                
                let counts = { Pendente: 0, 'Em Andamento': 0, Concluido: 0 };

                if (snapshot.empty) {
                    relatosListEl.innerHTML = '<p class="text-gray-500 text-center col-span-full py-10">Nenhum relato encontrado.</p>';
                    updateCounts(counts);
                    return;
                }

                let hasFilteredItems = false;
                snapshot.forEach((doc) => {
                    const relato = doc.data();
                    const id = doc.id;
                    
                    if (counts[relato.status] !== undefined) counts[relato.status]++;

                    if (currentFilter !== 'Todos' && relato.status !== currentFilter) {
                        return;
                    }
                    hasFilteredItems = true;

                    const el = document.createElement('div');
                    el.className = "bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition flex flex-col justify-between h-full";
                    
                    let statusColor = "bg-yellow-100 text-yellow-800 border-yellow-200";
                    if (relato.status === "Em Andamento") statusColor = "bg-blue-100 text-blue-800 border-blue-200";
                    if (relato.status === "Concluido") statusColor = "bg-green-100 text-green-800 border-green-200";
                    
                    const date = relato.timestamp ? new Date(relato.timestamp.seconds * 1000).toLocaleDateString() : '-';

                    // Escapa caracteres especiais para passar na fun√ß√£o JS
                    const safeDesc = relato.descricao.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    el.innerHTML = `
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xs font-mono text-gray-400">ID: ${id.substring(0, 4)}...</span>
                                <span class="text-xs px-2 py-1 rounded-full border ${statusColor} font-bold">${relato.status}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg mb-2 line-clamp-2">${relato.descricao}</h3>
                            <div class="text-xs text-gray-500 space-y-1 mb-4">
                                <p class="flex items-center gap-1"><span class="text-gray-400">üìç</span> ${relato.latitude?.toFixed(4)}, ${relato.longitude?.toFixed(4)}</p>
                                <p class="flex items-center gap-1"><span class="text-gray-400">üìÖ</span> ${date}</p>
                            </div>
                            <button id="btn-ai-${id}" onclick="window.analyzeImpact('${safeDesc}', 'btn-ai-${id}')" class="mb-4 w-full text-xs bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-1.5 rounded shadow hover:opacity-90 transition flex justify-center items-center gap-2">
                                ‚ú® Analisar Impacto
                            </button>
                        </div>
                        <div class="flex gap-2 pt-3 border-t border-gray-50 mt-auto">
                            ${relato.status !== 'Concluido' ? `
                                <button data-id="${id}" data-status="Em Andamento" class="btn-update flex-1 bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100 transition">Atender</button>
                                <button data-id="${id}" data-status="Concluido" class="btn-update flex-1 bg-green-50 text-green-600 text-xs font-bold py-2 rounded hover:bg-green-100 transition">Concluir</button>
                            ` : '<span class="text-xs text-gray-400 w-full text-center py-2 italic">Finalizado</span>'}
                        </div>
                    `;
                    relatosListEl.appendChild(el);
                });

                updateCounts(counts);

                if (!hasFilteredItems) {
                    relatosListEl.innerHTML = `<p class="text-gray-500 text-center col-span-full py-10">Nenhum relato encontrado para o filtro "${currentFilter}".</p>`;
                }
                
                addUpdateListeners();

            }, (error) => {
                // EXPOSING ERROR FOR DEBUGGING: Missing or insufficient permissions
                if (error.code === 'permission-denied') {
                    // Mensagem de ajuda mais clara para o professor/usu√°rio
                    relatosListEl.innerHTML = '<p class="text-center col-span-full text-red-500 py-10">ERRO: Permiss√£o Negada. Para funcionar, as regras de seguran√ßa do Firestore devem permitir ao Gestor (usu√°rio autenticado) ler a cole√ß√£o completa de relatos p√∫blicos.</p>';
                } else {
                    console.error("Erro ao buscar relatos (Web): ", error);
                    showToast("Erro ao carregar relatos.", true);
                }
            });
        }

        function updateCounts(counts) {
            document.getElementById('count-pend').innerText = counts['Pendente'];
            document.getElementById('count-and').innerText = counts['Em Andamento'];
            document.getElementById('count-conc').innerText = counts['Concluido'];
        }
        
        function addUpdateListeners() {
            document.querySelectorAll('.btn-update').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.dataset.id;
                    const status = button.dataset.status;
                    updateRelatoStatus(id, status);
                });
            });
        }

        async function updateRelatoStatus(id, status) {
            if (!dbInitialized) {
                showToast("Erro de conex√£o.", true);
                return;
            }
            
            const docRef = doc(db, "artifacts", appId, "public", "data", "relatos", id);
            
            try {
                await updateDoc(docRef, {
                    status: status
                });
                showToast(`Status atualizado para: ${status}`, false);
            } catch (error) {
                console.error("Erro ao atualizar status: ", error);
                showToast("Erro ao atualizar status.", true);
            }
        }
        
        window.setFilter = function(filter) {
            currentFilter = filter;
            
            Object.values(filterButtons).forEach(button => {
                button.classList.remove('bg-gray-800', 'text-white');
                button.classList.add('bg-white', 'text-gray-600');
            });
            if (filterButtons[filter]) {
                filterButtons[filter].classList.remove('bg-white', 'text-gray-600');
                filterButtons[filter].classList.add('bg-gray-800', 'text-white');
            }
            loadRelatos(); 
        }

        // --- Fun√ß√µes de UI ---

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification-web');
            toast.textContent = message;
            if (isError) {
                toast.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-lg transition-all duration-300 z-50 font-bold';
            } else {
                toast.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-full shadow-lg transition-all duration-300 z-50 font-bold';
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function loadMockData() {
            relatosListEl.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow border border-gray-200">
                    <h3 class="font-semibold text-gray-800">Erro de conex√£o. Estes s√£o dados de exemplo (Mock).</h3>
                    <p class="text-sm text-gray-500 mt-1">Status: Pendente</p>
                </div>
            `;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const btnLogout = document.getElementById('btn-logout-web');
            if (btnLogout) {
                btnLogout.addEventListener('click', window.logOut);
            }

            Object.keys(filterButtons).forEach(key => {
                if (filterButtons[key]) {
                    filterButtons[key].addEventListener('click', () => window.setFilter(key));
                }
            });
            
            initializeFirebase();
        });
    </script>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans">

    <!-- Tela de Login (Inicial) -->
    <div id="screen-login" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center p-6 text-center">
        <h1 class="text-3xl font-bold text-red-600 mb-4">Painel Gestor</h1>
        <p class="text-gray-500 mb-8">Conectando ao Sistema...</p>
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600"></div>
    </div>
    
    <!-- Conte√∫do Principal do Painel -->
    <div id="main-content" class="hidden h-full w-full">
        <div class="flex h-full">
            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-xl z-10">
                <div class="p-6 border-b border-gray-100">
                    <h1 class="text-xl font-bold text-red-600 flex items-center gap-2">
                        <span class="text-2xl">‚ôªÔ∏è</span> Sustenta CE
                    </h1>
                </div>
                <nav class="flex-1 p-4 space-y-1">
                    <a href="#" class="flex items-center gap-3 px-4 py-3 bg-red-50 text-red-700 rounded-lg font-medium transition-colors">
                        üìä Dashboard
                    </a>
                    <a href="#" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                        üë• Equipes
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center gap-3 mb-4 px-2">
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 font-bold">G</div>
                        <div>
                            <p class="text-sm font-bold text-gray-700">Admin</p>
                            <p class="text-xs text-green-600">Online</p>
                        </div>
                    </div>
                    <button id="btn-logout-web" class="flex items-center justify-center gap-2 w-full px-4 py-2 text-sm font-bold text-red-600 border border-red-100 hover:bg-red-50 rounded-lg transition-colors">
                        Sair
                    </button>
                </div>
            </aside>
            
            <!-- √Årea de Conte√∫do -->
            <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">
                <header class="bg-white border-b border-gray-200 px-8 py-5 flex justify-between items-center shadow-sm">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Vis√£o Geral</h2>
                        <p class="text-sm text-gray-500">Monitoramento em tempo real</p>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button id="filter-todos" class="filter-btn bg-gray-800 text-white shadow-sm px-4 py-1.5 rounded-md text-sm font-medium transition-all">Todos</button>
                        <button id="filter-pendente" class="filter-btn text-gray-600 px-4 py-1.5 rounded-md text-sm font-medium hover:bg-gray-200 transition-all">Pendentes</button>
                        <button id="filter-andamento" class="filter-btn text-gray-600 px-4 py-1.5 rounded-md text-sm font-medium hover:bg-gray-200 transition-all">Andamento</button>
                        <button id="filter-concluido" class="filter-btn text-gray-600 px-4 py-1.5 rounded-md text-sm font-medium hover:bg-gray-200 transition-all">Conclu√≠dos</button>
                    </div>
                </header>
                
                <main class="flex-1 overflow-y-auto p-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-400 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Ocorr√™ncias Pendentes</p>
                                <p class="text-3xl font-bold text-gray-800" id="count-pend">0</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg text-yellow-600 text-2xl">‚ö†Ô∏è</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-400 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Em Atendimento</p>
                                <p class="text-3xl font-bold text-gray-800" id="count-and">0</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg text-blue-600 text-2xl">üöö</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-400 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Casos Resolvidos</p>
                                <p class="text-3xl font-bold text-gray-800" id="count-conc">0</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg text-green-600 text-2xl">‚úÖ</div>
                        </div>
                    </div>

                    <!-- Grid de Relatos -->
                    <div id="relatos-grid">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">Relatos Recentes</h3>
                        <div id="relatos-list-web" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-10">
                            <!-- Cards via JS -->
                            <div class="col-span-full text-center py-10 text-gray-400">Carregando dados...</div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification-web" class="hidden"></div>

</body>
</html>